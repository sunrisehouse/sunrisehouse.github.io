{"componentChunkName":"component---src-page-template-post-tsx","path":"/posts/35/","result":{"pageContext":{"post":{"id":35,"title":"Toss Slash23 (3) - 분산 추적 체계 & 로그 중심으로 Observability 확보하기","dateString":"2023-07-13","description":"Toss Slash 를 너무 재밌게 보고 정리해보았다.","mainImageUrl":"/images/35-0.webp","postThemes":[{"name":"post","id":1}],"html":"<h1 id=\"분산-추적-체계--로그-중심으로-observability-확보하기\" style=\"position:relative;\"><a href=\"#%EB%B6%84%EC%82%B0-%EC%B6%94%EC%A0%81-%EC%B2%B4%EA%B3%84--%EB%A1%9C%EA%B7%B8-%EC%A4%91%EC%8B%AC%EC%9C%BC%EB%A1%9C-observability-%ED%99%95%EB%B3%B4%ED%95%98%EA%B8%B0\" aria-label=\"분산 추적 체계  로그 중심으로 observability 확보하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>분산 추적 체계 &#x26; 로그 중심으로 Observability 확보하기</h1>\n<p><a href=\"https://youtu.be/Ifz0LsfAG94\">보러가기</a></p>\n<blockquote>\n<p><strong>시스템의 Observability 의 중요성을 알게됐다.</strong></p>\n<p>신용 카드 프로젝트를 하면서 개발자들이 APM 솔루션에 많은 관심을 갖고 여러 항목들을 고려했다. 그때 당시에는 역시 운영을 해야하니까 이런게 중요한가보다 정도의 생각만 했었다. 이 영상을 보고나서는 좀 더 그 마음에 공감이 됐던 것 같고 로깅 시스템이 목표가 무엇인지 알 수 있었다. 프로젝트의 개발자들이 제시한 고려사항들은 운영 시 자신들이 받았던 질문들에 이 APM 이 답할 수 있는가 였었다. 로그나 지표들을 통해서 해결해야만하는 질문들에 답할 수 있는 시스템을 구축하는 것이 운영에 얼마나 중요한지 알게됐다. 토스에서 적용했던 방법들을 이번 프로젝트에서도 잘 가다듬어 적용해보고 싶다. 하지만 제대로된 운영을 해본적이 없어서 어떤 질문들이 있는지 노하우가 없어서 잘 할 수 있을지 모르겠다. 설계 단계에서 로그 시스템을 어디까지 설계해야할까도 궁금하다. 운영을 하진 않아서 로그 시스템을 그렇게 중요하게 생각하지 않을수도 있겠다는 생각이 들었다. 로그 시스템에 대한 설계가 궁금하다.</p>\n</blockquote>\n<blockquote>\n<p><strong>재밌었다</strong></p>\n<p>한 api 에 대한 분산 추적 뿐만 아니라 Global Trace ID 를 추가해 비즈니스 관점에서 연관 있는 api 들에 대해서 추적할 수 있게 한 것도 재밌었다. 클라이언트에서부터 서버까지의 동작들을 추적할 수 있는 시스템을 구축한 것도 재미있다. 이전 스타트업들에서 사용자의 행동을 추적하기 위해서 버튼마다 추적 id 를 심었던 (아주 귀찮았던) 것이 생각난다. 정말 유의미한 데이터를 뽑아낼 수 있을 것 같다는 생각이들고 그 많은 로그들을 어떻게 관리하나 궁금했는데 다음 영상에 또 있다. 좋다!</p>\n</blockquote>\n<h2 id=\"로그-시스템이-중요한-이유\" style=\"position:relative;\"><a href=\"#%EB%A1%9C%EA%B7%B8-%EC%8B%9C%EC%8A%A4%ED%85%9C%EC%9D%B4-%EC%A4%91%EC%9A%94%ED%95%9C-%EC%9D%B4%EC%9C%A0\" aria-label=\"로그 시스템이 중요한 이유 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>로그 시스템이 중요한 이유</h2>\n<p>기술의 기반 환경이 점점 가상화, 추상화 되고 있다. 이는 문제 발생 시 추적하는 것을 어려워지게 만들었다. 수시로 업데이트 되는 MSA 상의 서비스와 의존 관계, 동적으로 변경되는 인프라, 단일 요청을 처리함에도 여러 개의 예측할 수 없는 네트워크 홉을 지나야 하는 구조, 높은 cardinality 를 가진 지표는 기존의 일반적인 모니터링 기반의 문제 탐색을 어렵게 한다.</p>\n<h2 id=\"obsevarbility\" style=\"position:relative;\"><a href=\"#obsevarbility\" aria-label=\"obsevarbility permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>obsevarbility</h2>\n<p>전기 공학자 루돌프 칼만 say</p>\n<p>\"시스템의 출력으로부터 시스템의 상태를 이해할 수 있는 능력\"</p>\n<ul>\n<li>겪어보지 못한 새로운 현상에 대한 가시성(obsaverbility) 을 제공하고 원인에 대한 질문에 답할 수 있는 시스템을 만들어야 한다.</li>\n<li>개발자: 로그나 실시간으로 수집되고 잇는 모니터링 지표와 같은 출력을 통해 시스템의 상태를 이해할 수 있는 능력</li>\n<li>로그를 통해 당시 시스템 상황을 이해하는데 도움이 되어야 한다.</li>\n</ul>\n<h2 id=\"분산-추적-확장\" style=\"position:relative;\"><a href=\"#%EB%B6%84%EC%82%B0-%EC%B6%94%EC%A0%81-%ED%99%95%EC%9E%A5\" aria-label=\"분산 추적 확장 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>분산 추적 확장</h2>\n<p>분산 추적 시스템의 표준화</p>\n<p>분산 추적 시스템은 World Widw Web Consortium 이 정의한 Trace Context 규격으로 통일되는 중이다. 토스 페이먼츠는 분산 추적 시스템에 대한 표준에서 좀 더 확장해서 사용한다.</p>\n<h4 id=\"1-global-trace-id\" style=\"position:relative;\"><a href=\"#1-global-trace-id\" aria-label=\"1 global trace id permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Global Trace Id</h4>\n<p>비즈니스 관점에서 하나의 요청이 아닌 하나의 사용자 시나리오 전체를 이해해야 하는 상황에서 활용 가능. 하나의 시나리오에 Global Trace Id 부여한다.</p>\n<img src=\"/images/33-27.jpg\" style=\"width:100%\" />\n<blockquote>\n<p>나중가서는 여러 시나리오 간에 연관성도 추적할 수 있을 것 같은데 그 때 되면 Global Trace ID 말고 또 Trace Id 를 심을 것인가.\r\n확장성 있게 설계하려면 어떻게 해야할까?\r\n각 동작 요소마다의 ID 를 주고 그 ID 를 그룹으로 묶어서 관리한다는 어떨까??</p>\n</blockquote>\n<h4 id=\"2-추적-문맥-전파-항목-추가\" style=\"position:relative;\"><a href=\"#2-%EC%B6%94%EC%A0%81-%EB%AC%B8%EB%A7%A5-%EC%A0%84%ED%8C%8C-%ED%95%AD%EB%AA%A9-%EC%B6%94%EA%B0%80\" aria-label=\"2 추적 문맥 전파 항목 추가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 추적 문맥 전파 항목 추가</h4>\n<p>API 호출한 client 버전, 호출한 Service 명, 관련 고객사 등 항목을 추가했다.</p>\n<h5 id=\"3-추적-범위-확장\" style=\"position:relative;\"><a href=\"#3-%EC%B6%94%EC%A0%81-%EB%B2%94%EC%9C%84-%ED%99%95%EC%9E%A5\" aria-label=\"3 추적 범위 확장 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 추적 범위 확장</h5>\n<p>CDN, 방화벽, Load balancer, Istio gateway, istio sidecar, 각 서비스 서버, DB trace id 를 이요해 전 구간의 로그를 확인할 수 있도록 한다.</p>\n<ul>\n<li>개발 방법\n<ul>\n<li>DB 의 경우 쿼리의 주석 부분에 추적 문맥 포함</li>\n<li>TCP 서버: 요청 본문을 변경하지 않고 추가 정보를 보낼 수 있는 방법이 없어 어렵다.</li>\n<li>L4 load balancer 에서는 tcp 요청 본문을 변경하지 않고 클라이언트 정보를 보존하여 전달하는 방법있다.</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"4-추적-id-는-client-로부터-발행\" style=\"position:relative;\"><a href=\"#4-%EC%B6%94%EC%A0%81-id-%EB%8A%94-client-%EB%A1%9C%EB%B6%80%ED%84%B0-%EB%B0%9C%ED%96%89\" aria-label=\"4 추적 id 는 client 로부터 발행 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. 추적 id 는 client 로부터 발행</h4>\n<p>프론트엔드 로직은 서버와 통신을 시작하기 전부터 로직이 실행될 수 있다. 경우에 따라 서버와의 통신 이전에  사용자와의 인터렉션이 발생할 수 있기 때문에 문제가 발생할 당시의 문맥을 이해하기 위해서는 문맥을 이어줄 trace id 가 미리 발급되어 있어야 한다.</p>\n<h2 id=\"질문에-답할-수-있는-시스템을-만들어야-한다\" style=\"position:relative;\"><a href=\"#%EC%A7%88%EB%AC%B8%EC%97%90-%EB%8B%B5%ED%95%A0-%EC%88%98-%EC%9E%88%EB%8A%94-%EC%8B%9C%EC%8A%A4%ED%85%9C%EC%9D%84-%EB%A7%8C%EB%93%A4%EC%96%B4%EC%95%BC-%ED%95%9C%EB%8B%A4\" aria-label=\"질문에 답할 수 있는 시스템을 만들어야 한다 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>\"질문에 답할 수 있는 시스템을 만들어야 한다\"</h2>\n<ul>\n<li>ex 1) 의도하지 않은 동일한 요청이 세번 들어왔다. 사용자가 세번 호출한 건지, 인프라 내부 retry 로직이 세번 호출한 것인지?</li>\n<li>ex 2) api 수정 시 어떤 서비스의 api 들이 영향을 받는지?</li>\n</ul>\n<h2 id=\"다른-활용법\" style=\"position:relative;\"><a href=\"#%EB%8B%A4%EB%A5%B8-%ED%99%9C%EC%9A%A9%EB%B2%95\" aria-label=\"다른 활용법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>다른 활용법</h2>\n<p>istio 를 활용해 문맥 전파 중에 특정 문맥을 가진 요청은 특정 서비스로 갈 수 있게 활용할 수 있었다.</p>\n<img src=\"/images/33-30.jpg\" style=\"width:100%\" />"}}},"staticQueryHashes":[],"slicesMap":{}}